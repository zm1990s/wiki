---
layout: default
title: Avi 部署使用指南(5)：Avi VS 常见配置
parent: Avi
grand_parent: VMware
nav_order: 5
permalink: /docs/vmware/avi/avivs
---

# Avi 部署使用指南(5)：Avi VS 常见配置


## 目录
{: .no_toc .text-delta }

1. TOC
{:toc}

## 1. HTTP到HTTPS重定向

配置步骤：

1、创建virtual service，设置80和443两个端口，其中443勾选SSL

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image051-3822368.png)

2、在“Application Profile”中勾选“System-Secure-HTTP”

![Graphical user interface, text, application, email, website  Description automatically generated](../../../pics/image052-3822368.png)

3、为virtual Service关联SSL profile和证书

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image053-3822368.png)

4、访问测试

![Graphical user interface, text, website  Description automatically generated](../../../pics/image054-3822368.png)

在Client inspect请求，发现http被重定向到 https

![Graphical user interface, text, application  Description automatically generated](../../../pics/image055-3822368.png)

 

注意：如果不想使用默认的System-Secure-HTTP profile，可以新建一个profile，然后开启下列选项，即可实现重定向：

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image056-3822368.png)

## 2. 访问请求中插入X-Forwarded-For

默认System-HTTP Application profile会开启此功能，直接在virtual service调用即可：

![Graphical user interface, text, application, email, website  Description automatically generated](../../../pics/image057-3822414.png)

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image058-3822414.png)

 

在server端抓包结果：

![Graphical user interface, application  Description automatically generated](../../../pics/image059-3822414.png)



## 3. 为同一个virtual service设置多个端口

在某些情况下，单个virtual service 需要使用多个端口，并连接到后端服务器的相应端口，例如：virtual service 同时使用7071，7072，7073 三个端口，分别转发给后端server的7071，7072，7073三个端口。

配置步骤：

1、在 virtual Service中使用高级向导创建新的服务

![Graphical user interface, application  Description automatically generated](../../../pics/image062-3822535.png)

 

2、应用类型选择“System-L4-Application”

![Graphical user interface, text, application, email, website  Description automatically generated](../../../pics/image063-3822535.png)

3、在Service Port 中添加三个端口

![Graphical user interface, text, email  Description automatically generated](../../../pics/image064-3822535.png)

4、为virtual service 添加Pool

![Graphical user interface, text, application  Description automatically generated](../../../pics/image065-3822535.png)

5、在向导的第三步中，勾选“Disable Port Translation”

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image066-3822535.png)



## 4. 导入公信证书

默认Avi会生成自签名证书，可以用于HTTPS应用，但一般生产环境下会使用CA签发的或者购买的公信证书，因此需要在Avi中导入CA根证书、服务器证书及私钥。

 

步骤：

1、准备CA根证书/中间证书，服务器证书和证书密钥：

![Graphical user interface, text, application, chat or text message  Description automatically generated](../../../pics/image078-3822589.png)

![Graphical user interface, text, application  Description automatically generated](../../../pics/image079-3822589.png)

2、导入根证书和中间证书

![Graphical user interface  Description automatically generated](../../../pics/image080-3822589.png)

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image081-3822589.png)

![Table  Description automatically generated](../../../pics/image082-3822589.png)

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image083-3822589.png)

![Graphical user interface, text, application  Description automatically generated](../../../pics/image084-3822589.png)

 

 

3、导入server 证书和 key

![Graphical user interface, text, email  Description automatically generated](../../../pics/image085-3822589.png)

![Graphical user interface, text, application  Description automatically generated](../../../pics/image086-3822589.png)

 

4、导入完成后：

![Graphical user interface  Description automatically generated](../../../pics/image087-3822589.png)

5、创建 HTTPS 应用：

![Graphical user interface, application  Description automatically generated](../../../pics/image088-3822589.png)

6、服务创建后通过域名访问应用进行测试：

![Graphical user interface, text, application  Description automatically generated](../../../pics/image089-3822589.png)

## 5. 内容交换

内容交换（Content Switching）可以用于根据用户访问的路径将请求转发给不同的后端池，例如将图片发送给专门的图片缓存服务器等。

Avi 支持两种内容交换配置：HTTP Request policy 和Datascript，一般建议使用HTTP Request policy。

配置步骤：

1、创建两个 pool，第一个pool中的server提供普通的服务，第二个pool中的server提供图片服务：

![Graphical user interface, text  Description automatically generated with medium confidence](../../../pics/image090-3822657.png)

 

![Graphical user interface  Description automatically generated](../../../pics/image091-3822657.png)

 

2、通过Advanced 向导创建virtual service，在pool中选择Pool-1作为主要pool

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image092-3822657.png)

 

3、在Step2：policies中添加 HTTP Request Policy，设置content switch规则：

![Graphical user interface, application  Description automatically generated](../../../pics/image093-3822657.png)

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image094-3822657.png)

 

![Graphical user interface, text, application  Description automatically generated](../../../pics/image095-3822657.png)

4、创建完成后virtual service监控界面会有两个pool：

![Graphical user interface, application  Description automatically generated](../../../pics/image096-3822657.png)

 

5、通过浏览器测试可以正常访问页面

![Graphical user interface, text, website  Description automatically generated](../../../pics/image097-3822657.png)

 

临时勾选virtual service 的Non-significant-log以查看详细的访问日志：

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image098-3822657.png)

 

测试发现 img 路径被转发到了pool-2

![Graphical user interface, application  Description automatically generated](../../../pics/image099-3822657.png)

 

其他访问路径则是被转发到了Pool-1

![Graphical user interface, application  Description automatically generated](../../../pics/image100-3822657.png)

## 6. Virtual hosting

Virtual hosting 可以实现将不同域名的访问请求转发给不同池，或者将同一域名的不同路径转发给不同的 server。

使用 virtual hosting时，每个child vs 有自己独立的管理和监控界面，可以共享parent vs 的VIP和SSL证书。

目前Avi下有两种virtual hosting模式，SNI和EVH，两者相比有下列区别：

SNI： Child VS 必须通过https访问，多个Child VS可以共享VIP，但不能共享域名。仅能根据不同域名将流量转发到不同的池；

![Diagram  Description automatically generated with low confidence](../../../pics/image101-3822832.png)

EVH：Child VS同时支持http和https，多个Child VS可以共享VIP，可以根据host（域名或者IP）及path来进行条件匹配。

![Diagram  Description automatically generated](../../../pics/image102-3822832.png)

具体详见：https://avinetworks.com/docs/20.1/enhanced-virtual-hosting/

 

### SNI配置方式

配置步骤：

1、创建parent VS，启用 virtual hosting vs，type设置为SNI

![Graphical user interface, text, application, chat or text message  Description automatically generated](../../../pics/image103-3822832.png)

设置端口、默认的pool、证书。注意在SNI下parent vs 必须开启SSL。

![Graphical user interface, application  Description automatically generated](../../../pics/image104-3822832.png)

![Graphical user interface, application, Word  Description automatically generated](../../../pics/image105-3822832.png)

 

2、创建 Child VS，启用virtual hosting

![Graphical user interface, text, application, chat or text message  Description automatically generated](../../../pics/image106.png)

 

设置域名和需要使用的pool，证书。

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image107.png)

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image108.png)

 

访问测试：

![Graphical user interface, text, website  Description automatically generated](../../../pics/image109.png)

 

### EVH（Enhanced Virtual Hosting）

EVH 是 Avi 20.1.3后提供的新功能，可以根据host和path进行请求转发。

 

配置步骤：

1、创建parent VS，启用 virtual hosting vs，type设置为Enhanced Virtual Hosting

![Graphical user interface, text, application, chat or text message  Description automatically generated](../../../pics/image110.png)

设置端口、默认的pool、证书

![Graphical user interface, text, application  Description automatically generated](../../../pics/image111.png)

 

2、创建 Child VS，启用virtual hosting

![Graphical user interface, text, application  Description automatically generated](../../../pics/image112.png)

 

设置 Host 和path匹配条件。Host可以使用parent vs 的VIP或者域名。

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image113.png)

设置此child vs 的pool

![Graphical user interface, application  Description automatically generated](../../../pics/image114.png)

 

配置完成后的访问效果：

![Graphical user interface, text  Description automatically generated](../../../pics/image115.png)

## 7. 移除访问路径中的字段

和上个章节描述的需求类似，唯一不同的是在要移除的path之后还有其他参数，例如：

原始请求： http://10.10.50.188/img/logo.svg 

转换后的请求：http://10.10.50.9/logo.svg

此需求可以通过 http Request policy的policy tokens实现，或者使用datascript实现。

### 7.1 通过HTTP Request policy实现

参考链接：https://avinetworks.com/docs/20.1/configuration-guide/applications/vs-policies/#policy-tokens

 

Policy tokens 可以将一个请求路径转换成多个 token，方便用户进行URL重组，例如：

访问请求： http://www1.avinetworks.com/docs/index.htm

| 原始Request | www1    | avinetworks | com     | docs    | Index.html |
| ----------- | ------- | ----------- | ------- | ------- | ---------- |
| Token       | host[0] | host[1]     | host[2] | path[0] | path[1]    |

可以通过下列配置修改请求URL：

New host： [www.host[1](http://www.host[1):]

New path：/host[0]/path[0:]

重组后的URL：[www.avinetworks.com/www1/docs/index.htm](http://www.avinetworks.com/www1/docs/index.htm)

 

配置方式：

1、为应用添加一个HTTP Request Policy，匹配条件为 path 起始为 /img，设置content switch 和rewrite URL，Rewrite URL 时，HOST header 保持不变（http://10.10.50.188），修改 path，只保留 path[1] 及之后的 path，且保留Query。

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image118.png)

2、查看访问日志，有 /img 路径时去掉了 /img 

![Graphical user interface, application  Description automatically generated](../../../pics/image119.png)

针对 / 路径，则没有进行URI rewrite

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image120.png)

### 7.2 通过datascript实现1

参考链接：https://avinetworks.com/docs/20.1/datascript-avi-http-get_path_tokens/

 

除了使用http Request policy，也可以用 datascript来修改请求中的路径，例如：

原始请求： http://10.10.50.188/img/logo.svg 

转换后的请求：http://10.10.50.9/logo.svg

除了修改路径外，同时本示例也配置了 content switch。

 

配置方式：在 HTTP Request Event Script 中添加下列内容：

path = avi.http.get_path()

if string.beginswith(path, "/img") then

 path="/"..avi.http.get_path_tokens(2)

 avi.http.set_path(path)

 avi.pool.select("Pool-2-img")

end

\# 注：get_path_tokens(2) 表示保留path变量中第二个token及之后的内容。

 

![Graphical user interface, text, application  Description automatically generated](../../../pics/image121.png)

![img](../../../pics/image122.png)

 

访问请求：

/img 路径：

![A screenshot of a computer  Description automatically generated with medium confidence](../../../pics/image123.png)

/ 路径

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image124.png)

### 7.3 通过datascript实现2

参考链接：

https://avinetworks.com/docs/20.1/datascript-string-sub/

 

除了使用path token，也可以使用 string.sub 来剔除某些字符。

 

配置方式：在 HTTP Request Event Script 中添加下列内容：

path = avi.http.get_path()

if string.beginswith(path, "/img") then

 path = string.sub(path, 5)

 avi.http.set_path(path)

 avi.pool.select("Pool-2-img")

end

\#注：string.sub(path, 5) 表示保留path变量中第五个字符（/img这四个字符之后的字符）开始之后的path。

 

![Graphical user interface, application  Description automatically generated](../../../pics/image125.png)

![Graphical user interface, text, application  Description automatically generated](../../../pics/image126.png)

 

访问请求：

/img 路径

![Graphical user interface, application  Description automatically generated](../../../pics/image127.png)

 

/ 路径

![Graphical user interface, application  Description automatically generated](../../../pics/image128.png)

## 8. 请求路径重定向

原始请求： http://10.10.50.34/app2 

转换后的请求：http://10.10.50.9/app1

 

配置方式1：

![Graphical user interface, text, application  Description automatically generated](../../../pics/image129.png)

访问请求

 

![Graphical user interface, application  Description automatically generated](../../../pics/image130.png)

 

配置方式2：

使用 datascript来修改请求中的路径。

 

配置方式：在 HTTP Request Event Script 中添加下列内容：

path = avi.http.get_path()

if string.beginswith(path, "/app2") then

 path = string.sub(path, 6)

 avi.http.set_path("/app1"..path)

end

 

![Graphical user interface, text, application, website  Description automatically generated](../../../pics/image131.png)

![Graphical user interface, application  Description automatically generated](../../../pics/image132.png)

访问请求：

![Graphical user interface, text, application  Description automatically generated](../../../pics/image133.png)

## 9. 修改客户端请求包头大小限制

默认Avi会限制单个Client请求包头最大为12KB，如果应用的请求包头会大于此限制，请求会被Avi丢弃且返回“414 Request-URI Too Large”，可以通过修改Application Profile来调整此值。

配置方式：

1、编辑应用当前使用的Application Profile（建议为应用新建一个，不要修改系统默认的System-HTTP）：

![Graphical user interface, text, application, email, website  Description automatically generated](../../../pics/image138.png)

2、在DDoS中找到“HTTP Size Settings”，修改“Client Max Header Field Size”。

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image139.png)

## 10. 在访问域名前加www

某些时候，用户希望访问根域名时自动加上 www，此需求可以通过datascript实现。

if string.beginswith(avi.http.hostname(),"www") == false then

  avi.http.redirect(avi.http.protocol() .. "://www." .. avi.http.hostname() .. avi.http.get_uri())

end

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image150.png)

访问效果：

![Graphical user interface, application  Description automatically generated](../../../pics/image151.png)

## 11. 全局黑名单

部分企业内会部署威胁情报分析软件，这些软件可以发现一些恶意攻击，发现后希望其他安全软件可以对相关的IP进行拉黑，禁止这些IP访问业务。

在 Avi侧，可以在Templates>Groups>IP Group中心间一个黑名单IP组。

![Graphical user interface, application  Description automatically generated](../../../pics/image167.png)

然后编辑virtual service，在Network Security 中基于IP组添加Deny 策略。

![Graphical user interface, text, application, email  Description automatically generated](../../../pics/image168.png)

## 12. 设置 SNAT 地址池

默认avi会使用每个SE 的data nic 来执行 SNAT，如果客户有特殊需求，可以手动指定SNAT 地址池或者使用VIP作为地址池，具体配置方式如下。

### 使用VIP 进行SNAT

编辑virtual service，在Advanced 中勾选“Use VIP as SNAT”，此选项仅支持Active/Standby高可用模式，不支持N+M或者Active/Active。

![A screenshot of a cell phone  Description automatically generated](../../../pics/image060-3822477.png)

 

### 自定义 SNAT 地址池

编辑virtual service，在Advanced 中设置“SNAT IP address”，注意设置的 SNAT 地址池必须和 VIP 在同一个网段。

 

![A screenshot of a cell phone  Description automatically generated](../../../pics/image061-3822477.png)