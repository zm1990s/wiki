---
layout: default
title: vSAN 搭建及测试
parent: vSAN
grand_parent: vmware
nav_order: 3
permalink: /docs/vmware/vsan/vsantest
---

**本文是公众号里一系列文章的合集，所以会很长，为了获取良好的阅读体验建议直接去公众号查看**

------
## 目录
{: .no_toc .text-delta }

1. TOC
{:toc}

---



## 大纲

vSAN 完整系列共包含下列文章，此处只收藏测试部分:

- [vSAN 相关的资料，也全放在了这里](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247483925&idx=1&sn=eb6105764de7f3d8a003dd07f5458832&chksm=f982723bcef5fb2d92edd01cee0adb3c7407be974309f7007f1dfb9b1bd3dfaeb857ae5ab93a&scene=21#wechat_redirect)



收集了一些常用的 vSAN 资料，其中很大一部分是官方网站的资料，可以在 https://storagehub.vmware.com/ 获取到。



- [一篇 vSAN 入门，送给大家](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247484078&idx=1&sn=2d793bf44a822315a647f001c7b9e628&chksm=f9827280cef5fb96a6be6a48dc83337187a20ac78678067c08bfd8fc3d5aa1376642adf27a21&scene=21#wechat_redirect)



鉴于很多人对 vSAN 理解不够（受传统存储架构的影响），尝试从架构层面去讲解 vSAN ，希望大家能有所收获。



- [如何在家搭建一套自己的实验平台(4)-开启vSAN](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247484899&idx=1&sn=f7112d93fafeaedbd7a1614df76fe838&chksm=f98275cdcef5fcdb900704a5a7ab1e1afbd09ef92f26ddb3d78e2296248ca5a18ae74ddda857&scene=21#wechat_redirect)



这篇算是对上一篇的补充，理论的落地版本。当然，有很多 vSAN 的原理知识并未提到，例如存储策略等，个人觉得，只有用到存储策略时，讲解这些内容才有意义。



- [如何在家搭建一套自己的实验平台(5)-如何把 vSAN 玩坏](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247484970&idx=1&sn=254730aa39662f67e52fb469a34d5bfc&chksm=f9827604cef5ff121c6d047a3c68f527d1c582b7e6d79793c554fcfa6f2013b89e72a30736ff&scene=21#wechat_redirect)



例如这篇，需要进行一些基础的 vSAN 测试，就不得不提存储策略中的 FTT~

除此之外，文章中也讲解了很多 vSAN 常见操作。



- [如何在家搭建一套自己的实验平台(6)-如何把 vSAN 塞满](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247485051&idx=1&sn=f7a979f188201403eab583ca7d678dd2&chksm=f9827655cef5ff43e5bba4d4e54fbaf1e80bdfc280a1ae0f62d83fc96a24b5b86ec378d4d031&scene=21#wechat_redirect)



基于对象的存储是 vSAN 很重要的属性，明白了对象就理解了 vSAN（同理，理解了对象就能家庭圆满）。



- [如何在家搭建一套自己的实验平台(8)-vSAN 换脑大法](https://mp.weixin.qq.com/s/G0K-mGp_2iiX3OwvUEWJ4Q)



在项目中不可避免地会遇到 vCenter 重装、主机迁移到其他 vSAN 的情况，本文详细介绍常见的迁移场景和方法。



- [如何在家搭建一套自己的实验平台(9)-vSAN 环境重装了 ESXi 会怎样？](https://mp.weixin.qq.com/s/NnBDIWkuRLshZ1mj1L3iBQ)



做 vSAN 时如果运气不好，配置了质量不好的 U 盘，ESXi 启动盘很容易挂掉，这时候只能换 U 盘重装，不过放心，vSAN 的数据并不会丢失，在正确配置下，业务不会有任何影响。



下面是所有文章的大纲([PDF 链接](/pics/vSAN.pdf))：



![vSAN](../../../pics/vSAN.jpg)



好了，以上便是所有文章的汇总，此公众号或许不会再写 vSAN 的文章（不过欢迎私信提问题），如果想了解 vSAN 的最新动向或者实践（坑），欢迎关注下列公众号：



坠落的私人空间站  （id：vChang1919）

VMware 中国  （id：vmwarechina)



---

## vSAN 搭建



0x00. 在做 vSAN 之前不得不说的



很久前写过一篇 vSAN 的介绍”[一篇vSAN入门，送给大家](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247484078&idx=1&sn=2d793bf44a822315a647f001c7b9e628&chksm=f9827280cef5fb96a6be6a48dc83337187a20ac78678067c08bfd8fc3d5aa1376642adf27a21&scene=21#wechat_redirect)“，文中简述了 vSAN 区别于传统存储的不同，以及基础架构，这篇着重讲点实践。



如果要用一个词来描述 vSAN 的最佳实践，那就是**兼容性**。如果能**严格**按照 vSAN 兼容列表配置缓存层 SSD、容量层HDD/SSD、RAID 卡，保证固件、驱动等全部兼容，距离一个”稳定“ 的vSAN只差一步，这一步就是使用和运维，而为了正确操作vSAN，vSAN 团队写了一系列手册（详见[vSAN相关的资料，也全放在了这里](http://mp.weixin.qq.com/s?__biz=MzUxODgwOTkyMQ==&mid=2247483925&idx=1&sn=eb6105764de7f3d8a003dd07f5458832&chksm=f982723bcef5fb2d92edd01cee0adb3c7407be974309f7007f1dfb9b1bd3dfaeb857ae5ab93a&scene=21#wechat_redirect)>vSAN GSS最佳实践）。 



编写这一系列手册的作者是 Chang Wang，他个人也有一个公众号，最近发了很多 vSAN 最佳实践、操作规范、非合规操作、常见问题，欢迎大家收藏关注！



![img](../../../pics/640)





0x01. vSAN 基础环境准备



构成一个 vSAN 需要以下环境：

- ESXi：一个集群需要使用同样的 ESXi 版本号，vSAN 要求 **ESXi 内存不低于 6GB**；
- vCenter：版本不低于 ESXi 的 vCenter，曾经就遇到过 vCenter 版本稍低于 vSphere结果导致 vSAN 集群建立不起来；
- 在vSAN兼容列表内的**缓存层** SSD：在vSAN兼容列表内的SSD分两种，一定要注意区别缓存层 SSD 和容量层SSD，两者性能、寿命、价格差异都很大；另外SSD固件和驱动也要相匹配；SSD 的容量不能低于容量层容量的 10%；
- 在vSAN兼容列表内的**容量层**HDD/SSD：在混合模式下，容量层全部使用 HDD；在全闪模式下，容量层全部使用 SSD，一个集群只能使用其中一种模式；另外HDD/SSD固件和驱动也要相匹配；
- 在vSAN兼容列表内的RAID卡：不仅RAID卡要在兼容列表内，固件、驱动和**部署模式**（直通 or RAID0）也要符合兼容列表的描述**。**
- 有带宽保障的专用万兆网络**：**vSAN 支持和其他流量共用物理链路，但前提是能够保障带宽，最合理的方案是使用独立的网络，为 vSAN 配置独立的 VMKernel 和 IP 地址。



为了更好交付 vSAN，个人**强烈建议**阅读以下两个 VMware 官方的手册：



**VMware vSAN 网络设计.pdf**

**VMware 虚拟 SAN 设计与规模设定指南.pdf**



回到我们的 mini 实验环境。



在前面的文章中已经部署好了 vCenter 及 ESXi，按照 vSAN 的需求，还缺 SSD、HDD 和网络，在第一篇中介绍过我的实验环境中既有 SSD 也有 HDD，刚好可以用于搭建混合配置的 vSAN。而在上一篇，也为 vSAN 规划了独立的网络，只需要配置通即可。





![img](../../../pics/640-20191116112711717)

接下来以 ESXi-01 为例演示如何配置 ESXi：



在 workstation 中为 ESXi 新增一块网卡，使用 192.168.11.0 的网段。



![img](../../../pics/640-20191116112711546)



新增两块硬盘，一块保存在宿主机 SSD 硬盘中，空间为4G（为了演示设置的稍微小一些）。



![img](../../../pics/640-20191116112711266)



![img](../../../pics/640-20191116112711262)



![img](../../../pics/640-20191116112711261)



![img](../../../pics/640-20191116112712797)



![img](../../../pics/640-20191116112710839)



新增第二块硬盘，大小选择10G，保存在宿主机 HDD 硬盘中。



![img](../../../pics/640-20191116112711808)



![img](https://mmbiz.qpic.cn/mmbiz_png/ory2UDHYWeOXZfibkxkMjJoejghicYDQbRWI0YTCodSiaLc7hpLYguNW8hlVryEjEhHOHs09Idnmp2sE71Y0bCXeA/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](https://mmbiz.qpic.cn/mmbiz_png/ory2UDHYWeOXZfibkxkMjJoejghicYDQbRsLHJrG8h5b2nFicvAN3rOlGoNz9SukhJicq0cKj6oGMyy4ibxduPzibWtQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



![img](../../../pics/640-20191116112711663)



![img](../../../pics/640-20191116112713407)



确认配置无误后，点击确定。



![img](../../../pics/640-20191116112712863)



返回 vCenter，选中主机，点击**重新扫描存储**。

![img](../../../pics/640-20191116112711917)



![img](../../../pics/640-20191116112712310)



扫描完成后检查能够正确识别刚添加的两块硬盘。



![img](../../../pics/640-20191116112712315)



扫描**网络>物理适配器**，确保新增的网卡也能正确识别到。



![img](../../../pics/640-20191116112712704)



点击虚拟交换机>**添加网络**。



![img](../../../pics/640-20191116112713651)



选择添加 **VMKernel 网络适配器**。



![img](../../../pics/640-20191116112713366)



选择新建标准交换机（vSAN 同时支持标准交换机和分布式虚拟机交换机，此处为了配置简单选用标准交换机）。



![img](../../../pics/640-20191116112712315-3874832.)



为新标准交换机分配适配器，选择新加的 vmnic1。



![img](../../../pics/640-20191116112712749)



![img](../../../pics/640-20191116112712714)



![img](../../../pics/640-20191116112713556)



设置 vSAN VMKernel，，需要填写 **VLAN ID**、勾选**可用服务**中的 **vSAN**。（此处环境限制，并未填写 VLAN ID）



![img](https://mmbiz.qpic.cn/mmbiz_png/ory2UDHYWeOXZfibkxkMjJoejghicYDQbREviaVUVjuLfD6seWFWylPJ6sAlubbSFlgy6icYouRwFcW3pLmHso44RQ/640?wx_fmt=png&tp=webp&wxfrom=5&wx_lazy=1&wx_co=1)



根据规划配置 vSAN VMKernel IP 地址（**切记此地址不能和 ESXi 管理网络同网段）**。



![img](../../../pics/640-20191116112713639)



ESXi01 的配置到此便完成了，按照同样的方式配置 ESXi02和 ESXi03，之后便可以去开启 vSAN 功能了。



0x02. 为集群开启 vSAN 功能





选中集群，点击**配置>vSAN>配置**。



![img](../../../pics/640-20191116112713792)



根据需求选择 vSAN 种类。



![img](../../../pics/640-20191116112714429)



设置高级存储功能。



![img](../../../pics/640-20191116112714408)



声明磁盘，系统会自动检测到三台主机上可用的 SSD 和 HDD，将 HDD 声明为容量层，SSD 声明为缓存层。



![img](../../../pics/640-20191116112713996)



![img](../../../pics/640-20191116112714054)



声明完成后，右上角会分别提示缓存层和容量层的容量和。



![img](../../../pics/640-20191116112714951)



配置故障域，故障域用于将一组可能同时发生故障的机器放在一组（例如共用一个PDU、在同一个机架），vSAN 不会将一个对象的两个副本放在同一个故障域的主机内。



默认每台主机都是一个故障域。



![img](../../../pics/640-20191116112714138)



检查配置无误后点击完成。



![img](../../../pics/640-20191116112714410)



等待所有主机配置完成，哗啦，vSAN 存储建成了，其容量等于所有容量层磁盘容量之和。



![img](../../../pics/640-20191116112714407)



现在我们导入一个虚拟机测试下存储能不能正常使用。



![img](../../../pics/640-20191116112714983)



![img](../../../pics/640-20191116112714659)



![img](../../../pics/640-20191116112714798)



![img](../../../pics/640-20191116112714965)



![img](../../../pics/640-20191116112717754)



![img](../../../pics/640-20191116112715454)



![img](../../../pics/640-20191116112716704)



开机，设置 IP 地址，访问其 Web 服务，一切均正常。



![img](../../../pics/640-20191116112715629)



![img](../../../pics/640-20191116112715455)

---全文完---

​                                               

​    

​                              

​          