---
layout: default
title: Jenkins ä¼ä¸šå¾®ä¿¡å¯¹æ¥
parent: K8s
grand_parent: Cloud Native
nav_order: 8
permalink: /docs/cloudnative/k8s/jenkinswechat
---

# Jenkins ä¼ä¸šå¾®ä¿¡å¯¹æ¥

{: .no_toc}

## ç›®å½•

{: .no_toc .text-delta }


1. TOC
{:toc}

## åŸºç¡€å‡†å¤‡ï¼šä¸ºç¾¤èŠå¼€å¯æœºå™¨äºº

åœ¨ç¾¤èŠçš„ä¸‹åˆ—ä½ç½®æ·»åŠ ç¾¤æœºå™¨äººï¼ˆç”µè„‘æˆ–æ‰‹æœºç«¯å‡æ”¯æŒæ­¤åŠŸèƒ½ï¼‰ï¼š

<img src="../../../pics/image-20231212104737425.png" alt="image-20231212104737425" style="zoom:50%;" />

æ·»åŠ å®Œæˆåè®°å½• webhook åœ°å€ï¼ˆæ³¨æ„æ­¤åœ°å€åƒä¸‡ä¸è¦å¤–æ³„ï¼‰ï¼š

<img src="../../../pics/image-20231212104901302.png" alt="image-20231212104901302" style="zoom:50%;" />

## åˆé˜¶ï¼šé€šè¿‡ä¼ä¸šå¾®ä¿¡æ’ä»¶æ¥å®ç°é€šçŸ¥

### å®‰è£…ä¼ä¸šå¾®ä¿¡å¯¹æ¥æ’ä»¶

åœ¨ Jenkins æ’ä»¶ç®¡ç†>Available ä¸­æœç´¢ wechatï¼Œå®‰è£… Qy Wechat Notification Pluginï¼š

![image-20231211191937664](../../../pics/image-20231211191937664.png)

åœ¨æµæ°´çº¿çš„æœ€åæ·»åŠ ä¸‹åˆ—å†…å®¹ï¼š

```yaml
// å‰é¢æ˜¯å®Œæ•´çš„ podtemplateï¼Œåœ¨æ‰€æœ‰ } ç»“æŸä¹‹åæ·»åŠ ä¸‹é¢çš„å†…å®¹
// æµæ°´çº¿è„šæœ¬è¯¦è§[ https://blog.halfcoffee.com/docs/cloudnative/k8s/jenkins]

pipeline {
    agent any

    stages {
        stage('post') {
            steps {
            echo 'post'
            }
        }
    }
    post{
        success{
                qyWechatNotification failNotify: true, webhookUrl: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b13e-bd29-aa1e74c65787', moreInfo:'æˆåŠŸ'
        }
        failure{
                qyWechatNotification failNotify: true, webhookUrl: 'https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b13e-bd29-aa1e74c65787', moreInfo:'å¤±è´¥'
        }
    }
}

```

æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼Œåœ¨ä¼ä¸šå¾®ä¿¡ä¸­å¯ä»¥æ”¶åˆ°é¡¹ç›®æ„å»ºæˆåŠŸæˆ–è€…å¤±è´¥çš„åŸºæœ¬æ¶ˆæ¯ï¼š

<img src="../../../pics/image-20231212105322251.png" alt="image-20231212105322251" style="zoom:50%;" />



## é«˜é˜¶ï¼šé€šè¿‡ curl è‡ªå®šä¹‰å‘é€çš„å†…å®¹

Jenkins ä¼ä¸šå¾®ä¿¡å¯¹æ¥æ’ä»¶èƒ½å‘é€çš„åŠŸèƒ½å¾ˆæœ‰é™ï¼Œäºæ˜¯è‡ªå·±å°è¯•ç”¨ curl æ¥è°ƒç”¨ webhook æ¥å‘é€æ¶ˆæ¯ï¼Œåªéœ€åœ¨æµæ°´çº¿çš„æœ€åæ·»åŠ ä¸‹åˆ—å†…å®¹ï¼Œå°† webhook åœ°å€æ›´æ”¹ä¸ºè‡ªå·±çš„åœ°å€å³å¯ï¼š


```yaml
// å‰é¢æ˜¯å®Œæ•´çš„ podtemplateï¼Œåœ¨æ‰€æœ‰ } ç»“æŸä¹‹åæ·»åŠ ä¸‹é¢çš„å†…å®¹
// æµæ°´çº¿è„šæœ¬è¯¦è§[ https://blog.halfcoffee.com/docs/cloudnative/k8s/jenkins]

pipeline {
    agent any

    stages {
        stage('post') {
            steps {
            echo 'post' 
            }
        }
    }
    post{
        success{
        script {
        def duration = currentBuild.durationString
def splitDuration = duration.split("and counting")[0]
        def message ="<font color='green'>ã€ ${env.JOB_NAME} ã€‘æ„å»ºæˆåŠŸ~ğŸ˜„</font> \n > æ„å»ºå·ç ï¼š ${env.BUILD_NUMBER} \n > æŒç»­æ—¶é—´ï¼š ${splitDuration} \n > æ‰§è¡Œäººï¼š ${currentBuild.buildCauses.shortDescription} \n > [æŸ¥çœ‹æ§åˆ¶å°](${env.BUILD_URL})"
      sh "curl -X POST -H 'Content-Type: application/json' -d '{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"${message}\"}}' https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b13e-bd29-aa1e74c65787"    
        }

        }
        failure{
        script {
        def duration = currentBuild.durationString
def splitDuration = duration.split("and counting")[0]
        def message ="<font color='red'>ã€ ${env.JOB_NAME} ã€‘æ„å»ºå¤±è´¥ï¼ğŸ˜­</font> \n > æ„å»ºå·ç ï¼š ${env.BUILD_NUMBER} \n > æŒç»­æ—¶é—´ï¼š ${splitDuration} \n > æ‰§è¡Œäººï¼š ${currentBuild.buildCauses.shortDescription} \n > [æŸ¥çœ‹æ§åˆ¶å°](${env.BUILD_URL})"
      sh "curl -X POST -H 'Content-Type: application/json' -d '{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"${message}\"}}' https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b13e-bd29-aa1e74c65787"    
        }
        }
    }
}
```

æ•ˆæœå¦‚ä¸‹ï¼š

<img src="../../../pics/image-20231212111639228.png" alt="image-20231212111639228" style="zoom:50%;" />

æœ€åä¸€ä¸ªé€šå‘Šå¯¹åº”çš„é˜¶æ®µè§†å›¾å¦‚ä¸‹ï¼Œå‰é¢ 5 ä¸ªé˜¶æ®µå‡ä¸º podtemplate çš„ stageï¼Œæœ€åä¸¤ä¸ªæ˜¯å‘é€æˆåŠŸæˆ–å¤±è´¥æ¶ˆæ¯çš„ stageï¼š

![image-20231212111627378](../../../pics/image-20231212111627378.png)

## å¦‚ä½•ä¸ Podtemplate è”åŠ¨

åœ¨æµ‹è¯•æ—¶å‘ç°ï¼Œå¦‚æœå°† pipeline å†…å®¹æ”¾åœ¨ podtemplateï¼Œåªæœ‰å‰é¢çš„ podtemplate æ‰§è¡ŒæˆåŠŸæ‰ä¼šæ‰§è¡Œåé¢çš„ pipelineï¼Œè¿™ä¼šå¯¼è‡´å®é™…ä¸Šåªæœ‰æˆåŠŸçš„è­¦å‘Šæ‰ä¼šå‘é€åˆ°ä¼ä¸šå¾®ä¿¡ï¼Œè§£æ³•æœ‰ä¸¤ç§ï¼š

- å…¨éƒ¨ä½¿ç”¨ pipelineï¼Œä¸ä½¿ç”¨ podtemplate
- åœ¨åŸå§‹æµæ°´çº¿ä¸­é€šè¿‡ pipeline åŠ å…¥æˆåŠŸçš„å‘Šè­¦ï¼Œå†æ–°å»ºä¸€ä¸ªæµæ°´çº¿ï¼Œè¿›è¡Œå¤±è´¥çš„å‘Šè­¦

ä¸‹é¢ä½¿ç”¨ç¬¬äºŒç§è¿›è¡Œæ¼”ç¤ºï¼š

ä¸»æµæ°´çº¿å†…å®¹å¦‚ä¸‹ï¼Œæ·»åŠ äº† pipelineï¼Œä»…åœ¨æˆåŠŸæ—¶å‘Šè­¦ï¼š

![image-20231212144414433](../../../pics/image-20231212144414433.png)

æ–°å»ºä¸€ä¸ªæµæ°´çº¿ï¼Œè®¾ç½®åœ¨ä¸Šé¢çš„æµæ°´çº¿æ‰§è¡Œå®Œåè§¦å‘ï¼š

<img src="../../../pics/image-20231212144459990.png" alt="image-20231212144459990" style="zoom:50%;" />

Pipeline ä½¿ç”¨ä¸‹é¢çš„è„šæœ¬ï¼Œè„šæœ¬ä¼šè·å– ruoiy-vue ä¸Šä¸€æ¬¡æ„å»ºçš„çŠ¶æ€ï¼Œå¦‚æœæŸ¥æ‰¾åˆ° FAILURE åˆ™é€€å‡ºï¼Œç„¶ååé¢çš„ post å†å‘é€æ„å»ºå¤±è´¥çš„è­¦å‘Šã€‚

```shell
pipeline {
    agent any

    stages {
        stage('post') {
            steps {
            sh '''
            curl https://jenkins.halfcoffee.com/job/ruoyi/job/ruoyi-vue/lastBuild/api/json | grep '"result":"FAILURE"' && exit 1
            '''
            }
        }
    }
    post{
        failure{
        script {
        def duration = currentBuild.durationString
def splitDuration = duration.split("and counting")[0]
        def message ="<font color='red'>ã€ruoyi-vueã€‘æ„å»ºå¤±è´¥ï¼ğŸ˜­</font> \n  > [æŸ¥çœ‹æ§åˆ¶å°](https://jenkins.halfcoffee.com/job/ruoyi/job/ruoyi-vue/lastBuild/)"
      sh "curl -X POST -H 'Content-Type: application/json' -d '{\"msgtype\": \"markdown\", \"markdown\": {\"content\": \"${message}\"}}' https://qyapi.weixin.qq.com/cgi-bin/webhook/send?key=b13e-bd29-aa1e74c65787"    
        }
        }
    }
}
```

