---
layout: default
title: Dify æ•°å­—äººå¯¹æ¥
nav_order: 11
parent: AI
permalink: /docs/ai/digitalhuman
---

# Dify æ•°å­—äººå¯¹æ¥

{: .no_toc}

## ç›®å½•

{: .no_toc .text-delta }


1. TOC
{:toc}

## æ¦‚è¿°

ç¾¤é‡Œçœ‹åˆ°æœ‰äººæ¨èäº†ä¸ªæ•°å­—äººçš„é¡¹ç›®å°è¯•äº†ä¸‹ï¼Œè®°å½•ä¸‹ä½¿ç”¨å’Œé…ç½®è¿‡ç¨‹ã€‚

é¡¹ç›®åœ°å€ï¼š

[https://github.com/wan-h/awesome-digital-human-live2d/tree/main](https://github.com/wan-h/awesome-digital-human-live2d/tree/main)

## æ¶æ„ä»‹ç»

å®˜æ–¹æœ‰è¿™æ ·çš„ä¸€ä¸ªæ¶æ„å›¾ï¼Œå¤§è‡´ç»“æ„å¦‚ä¸‹ï¼š

- ADH éƒ¨ç½²ï¼šä¼šæœ‰ä¸¤ä¸ªå®¹å™¨ï¼Œweb ä»¥åŠ API
  - Web é»˜è®¤ä½¿ç”¨ 3000 ç«¯å£ HTTP åè®®æš´éœ²ï¼ˆåŸºäº Next.jsï¼‰
  - API ä½¿ç”¨ 8000 æš´éœ²ï¼Œéœ€è¦æš´éœ² WSSï¼ˆç”¨äºå¿ƒè·³ï¼‰ä»¥åŠ HTTP
- Difyï¼šé€šå¸¸æ˜¯ ADH ç›´æ¥å’Œ Dify API æœåŠ¡é€šä¿¡ï¼Œä¸ä¼šæœ‰ç”¨æˆ·åˆ° Dify çš„è®¿é—®ã€‚å¦‚æœ Dify å’Œ ADH åœ¨åŒä¸€ä¸ªå†…ç½‘ï¼ŒADH å¯ä»¥ç›´æ¥è°ƒç”¨ Dify å†…ç½‘çš„ IPã€‚

![img](../../pics/arch.png)



## å®‰è£…

å‚è€ƒæ–‡æ¡£ï¼š[https://github.com/wan-h/awesome-digital-human-live2d/blob/main/docs/deploy_instrction.md](https://github.com/wan-h/awesome-digital-human-live2d/blob/main/docs/deploy_instrction.md)



### é»˜è®¤æ¨¡å¼å®‰è£…åŠé…ç½®

Docker æ–¹å¼å®‰è£…ï¼š

```shell
# ä¸‹è½½æºç 
git clone https://github.com/wan-h/awesome-digital-human-live2d.git

# é¡¹ç›®æ ¹ç›®å½•ä¸‹æ‰§è¡Œ
docker compose -f docker-compose-quickStart.yaml up -d
```



é»˜è®¤å®‰è£…åï¼ŒADH ä½¿ç”¨ repeater æ¨¡å¼ï¼ˆé»˜è®¤çš„æµ‹è¯•æ¨¡å¼ï¼‰ï¼Œå½“ç”¨æˆ·è¾“å…¥å†…å®¹çš„æ—¶å€™ï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å°†ç”¨æˆ·è¾“å…¥çš„å†…å®¹è½¬æ¢æˆè¯­éŸ³å†å›è¿‡æ¥ã€‚ä½¿ç”¨æ•ˆæœå¦‚ä¸‹ï¼š

<img src="../../pics/image-20250103134327353.png" alt="image-20250103134327353" style="zoom:50%;" />

ADH åå°é»˜è®¤ç”¨çš„æ˜¯å¾®è½¯çš„ [edge-tts æœåŠ¡ï¼ˆ](https://github.com/rany2/edge-tts/)å…è´¹çš„ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨ä¸­æ–‡ zh-CN-XiaoxiaoNeural è¯­éŸ³åŒ…ï¼Œå¯ä»¥æŒ‰éœ€ä¿®æ”¹ï¼ˆå‚è§â€œè‡ªå®šä¹‰å£°éŸ³â€ï¼‰ã€‚

#### æ·»åŠ  Dify åç«¯

å¦‚æœéœ€è¦å’Œæ•°å­—äººè¿›è¡Œå¯¹è¯ï¼Œåˆ™éœ€è¦é…ç½®åç«¯ï¼Œåœ¨ UI ä¸­å¯ä»¥é€šè¿‡ä¸‹åˆ—ä½ç½®é…ç½®ã€‚

æ­¤å¤„å’Œ Dify çš„ Chatflow è¿›è¡Œå¯¹æ¥ã€‚

Dify ä¾§ Chatflow ç¤ºæ„ï¼š

<img src="../../pics/image-20250103133706288.png" alt="image-20250103133706288" style="zoom:50%;" />

åœ¨æ­¤å¤„è·å– dify å¯¹æ¥ API keyï¼š

![image-20250103133731688](../../pics/image-20250103133731688.png)

è¿”å› ADHï¼Œåœ¨è®¾ç½®>æœåŠ¡ä¸­å¡«å†™ DifyAgent ç›¸å…³ä¿¡æ¯ï¼š

<img src="../../pics/image-20250103133502411.png" alt="image-20250103133502411" style="zoom:50%;" />

æµ‹è¯•ï¼š

<img src="../../pics/image-20250103133918850.png" alt="image-20250103133918850" style="zoom:50%;" />

#### è‡ªå®šä¹‰å£°éŸ³

å¯ä»¥é€šè¿‡è°ƒæ•´æ­¤é…ç½® `configs/engines/tts/edgeAPI.yaml`ï¼Œä¿®æ”¹ PER å‚æ•°ï¼ˆä¸‹é¢ä½¿ç”¨çš„æ˜¯ en-US-JennyNeuralï¼‰ã€‚

æ›´å¤šæ”¯æŒçš„å£°éŸ³æ¸…å•è§ï¼š[https://learn.microsoft.com/zh-cn/azure/ai-services/speech-service/language-support?tabs=tts](https://learn.microsoft.com/zh-cn/azure/ai-services/speech-service/language-support?tabs=tts)ï¼Œç»è¿‡æµ‹è¯•å•è¯­è¨€å¯ä»¥æ­£å¸¸å·¥ä½œï¼Œä½†æ˜¯Multilingua çš„ä¼šæœ‰é—®é¢˜ã€‚

å…·ä½“çš„é…ç½®ç¤ºä¾‹ï¼š

```shell
NAME: "EdgeAPI"
VERSION: "v0.0.1"
PER: "en-US-JennyNeural"
#PER: "zh-CN-XiaoxiaoNeural"
RATE: "+0%"
VOL: "+0%"
PIT: "+0Hz"
```

ä¿®æ”¹å®Œæˆåï¼Œéœ€è¦ `docker compose down`åœæ­¢å®¹å™¨ï¼Œç„¶åå†`docker compose -f docker-compose-quickStart.yaml up -d`å¯åŠ¨å®¹å™¨ã€‚



### All in Dify ç›¸å…³é…ç½®

All in Dify æ¨¡å¼æ˜¯æŒ‡ TTSï¼ˆæ–‡å­—è½¬è¯­éŸ³ï¼‰ä»¥åŠ Speechtotextï¼ˆè¯­éŸ³è½¬æ–‡å­—ï¼‰å‡ç”± Dify æ¥å®ç°ã€‚

Dify ä¾§çš„ Chatflow ç­‰éœ€è¦å…ˆå¼€å¯è¯­éŸ³ç›¸å…³çš„è®¾ç½®ï¼Œæ¯”å¦‚ï¼ˆğŸ“¢æ³¨æ„ä¸è¦å¼€å¯è‡ªåŠ¨æ’­æ”¾åŠŸèƒ½ï¼‰ï¼š

<img src="../../pics/image-20250103142825353.png" alt="image-20250103142825353" style="zoom:50%;" />

æ¥ç€è¿›è¡Œéƒ¨ç½²ï¼š

```shell
# è¿›åˆ° ADH æºç ç›®å½•
cd awesome-digital-human-live2d
# ä½¿ç”¨ all in dify é…ç½®æ–‡ä»¶ï¼Œé»˜è®¤ä½¿ç”¨ config_template.yaml é…ç½®æ–‡ä»¶
cd configs
cp config_all_in_dify.yaml config.yaml
cd ..
docker compose -f docker-compose-quickStart.yaml up -d
```



#### difyTTS.py å¾®è°ƒ

é»˜è®¤ difyTTS.py æœ‰ä¸ª bugï¼Œéœ€è¦è¿›å…¥å®¹å™¨ä¿®æ”¹è„šæœ¬ï¼Œåˆ é™¤ç¬¬ 47 è¡Œï¼š

`docker ps` è·å– adh-api å®¹å™¨çš„ idï¼Œè¿›å…¥å®¹å™¨ï¼š

```
docker exec -it ceb570f80abc bash
```

ç¼–è¾‘ difyTTS.pyï¼Œ åˆ é™¤ç¬¬ 47 è¡Œï¼Œè°ƒæ•´ç¬¬ 48 è¡Œçš„ç¼©è¿›ã€‚

`vi digitalHuman/engine/tts/difyTTS.py`

```shell
#            async with self.asyncLock:
            resp = await httpxAsyncClient.post(API_URL + "/text-to-audio", json=payload, headers=headers)
```

é‡å¯ adh API æœåŠ¡ï¼š`docker compose restart adh_server`

### å°† dify ä½œä¸ºé»˜è®¤æœåŠ¡

ä½¿ç”¨é»˜è®¤é…ç½®éƒ¨ç½²å®Œ adh åï¼Œæ¯ä¸ªä¼šè¯éƒ½éœ€è¦å¡«å†™ dify çš„ keyï¼Œå¦‚æœæ˜¯å†…éƒ¨ä½¿ç”¨ï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹é…ç½®æ–‡ä»¶å°† dify é…ç½®å›ºåŒ–ï¼Œå¹¶è®¾ç½®ä¸ºé»˜è®¤ï¼Œå…·ä½“æœ‰ä¸¤å¤„éœ€è¦ä¿®æ”¹ï¼š

1. ä¿®æ”¹ difyAgent.yamlï¼Œå¡«å†™é»˜è®¤çš„ URL å’Œ keyï¼š`vi configs/agents/difyAgent.yaml` 

```yaml
NAME: "DifyAgent"
VERSION: "v0.0.1"
# æš´éœ²ç»™å‰ç«¯çš„å‚æ•°é€‰é¡¹ä»¥åŠé»˜è®¤å€¼
PARAMETERS: [
  {
    NAME: "DIFY_API_URL",
    DEFAULT: "http://10.x.x.x/v1"
  },
  {
    NAME: "DIFY_API_KEY",
    DEFAULT: "app-xxxxxxxxxx"
  },
  {
    NAME: "DIFY_API_USER",
    DEFAULT: "adh"
  }
]
```

2. ä¿®æ”¹ config.yamlï¼Œåœ¨ Agents ä¸­å°†é»˜è®¤çš„  repeaterAgent.yaml æ”¹ä¸º difyAgent.yaml ï¼š` vi configs/config.yaml`

```yaml
COMMON:
  NAME: "Awesome-Digital-Human"
  VERSION: "v0.0.1"
  LOG_LEVEL: "DEBUG"
SERVER:
  IP: "0.0.0.0"
  PORT: 8000
  ENGINES:
    ASR:
      SUPPORT_LIST: [ "baiduAPI.yaml", "googleAPI.yaml", "difyAPI.yaml" ]
      DEFAULT: "googleAPI.yaml"
    LLM:
      SUPPORT_LIST: [ "openaiAPI.yaml", "baiduAPI.yaml" ]
      DEFAULT: "openaiAPI.yaml"
    TTS:
      SUPPORT_LIST: [ "edgeAPI.yaml", "baiduAPI.yaml", "difyAPI.yaml" ]
      DEFAULT: "edgeAPI.yaml"
  AGENTS:
    SUPPORT_LIST: [ "repeaterAgent.yaml", "difyAgent.yaml", "fastgptAgent.yaml", "openaiAgent.yaml" ]
    DEFAULT: "difyAgent.yaml"
~
```



### ä¸º ADH é…ç½®åå‘ä»£ç†

å‚è€ƒæ–‡æ¡£ï¼š[https://github.com/wan-h/awesome-digital-human-live2d/blob/main/docs/Q%26A.md](https://github.com/wan-h/awesome-digital-human-live2d/blob/main/docs/Q%26A.md)



é»˜è®¤å‰ç«¯ä½¿ç”¨ 3000 ç«¯å£ï¼Œè°ƒç”¨åç«¯ä½¿ç”¨ 8000 ç«¯å£ï¼Œé…ç½®åå‘ä»£ç†æ—¶éœ€è¦åŸºäº path åˆ†åˆ«å°†è¯·æ±‚å‘é€åˆ°ä¸¤ä¸ªæœåŠ¡ï¼Œå…·ä½“çš„é…ç½®å¦‚ä¸‹ï¼š

- é»˜è®¤è·¯å¾„çš„è¯·æ±‚å‘é€ç»™ web çš„ 3000 ç«¯å£
- /adh è·¯å¾„å‘é€ç»™ api çš„ 8000 ç«¯å£
- å¼€å¯ websocket åŠŸèƒ½ï¼ˆå¿ƒè·³ï¼‰



å…·ä½“é…ç½®å¦‚ä¸‹ï¼š

```shell
# è·å– web å®¹å™¨çš„ idï¼š
docker ps
94976c84a1b9 registry.cn-hangzhou.aliyuncs.com/awesome-digital-human/adh-web:main-latest
```

```shell
# è¿›å…¥å®¹å™¨ï¼Œä¿®æ”¹ .env æ–‡ä»¶
docker exec -it 94976c84a1b9 sh

/workspace # vi .env

# å°†åè®®ä» http ä¿®æ”¹ä¸º httpsï¼Œç«¯å£ä» 8000 ä¿®æ”¹ä¸º 443

# è¿è¡Œä¸‹åˆ—å‘½ä»¤é‡æ–° build
/workspace # pnpm build

> web@0.1.0 build /workspace
> next build
...
# ç­‰å¾…å®Œæˆåé€€å‡ºå®¹å™¨
```

é‡å¯å®¹å™¨ï¼š

`docker compose restart adh_web`

å¯¹åº”çš„ Nginx é…ç½®ï¼ˆæ­¤å¤„ä½¿ç”¨ Nginx Proxy Managerï¼‰ï¼š

<img src="../../pics/image-20250103145709481.png" alt="image-20250103145709481" style="zoom:50%;" />

<img src="../../pics/image-20250103145749828.png" alt="image-20250103145749828" style="zoom:50%;" />

å¦‚æœéœ€è¦æ­¤é…ç½®æŒä¹…åŒ–ï¼Œå»ºè®®ä½¿ç”¨[æ­¤éƒ¨ç½²æ¨¡å¼](https://github.com/wan-h/awesome-digital-human-live2d/blob/main/docs/deploy_instrction.md#%E5%AE%B9%E5%99%A8%E9%83%A8%E7%BD%B2%E5%AE%B9%E5%99%A8%E5%BC%80%E5%8F%91%E9%A6%96%E9%80%89)ã€‚
