---
layout: default
title: Avi 安装部署
parent: Avi
grand_parent: vmware
nav_order: 1
permalink: /docs/vmware/avi/install
---

# Avi 安装部署

## 目录
{: .no_toc .text-delta }

1. TOC
{:toc}

# 概要

Avi networks 是 2019 年 VMware 收购的一家纯软件负载均衡公司， 此公司由一些前思科员工创立，在收购时其总融资额已有 1.15 亿美元，公司主要产品为 Avi vantage，这是一款可以和 F5 BIG-IP、Citrix Netscaler 等产品竞争的负载均衡产品。

VMware 收购 Avi 后，将其产品名称改为 NSX advanced Load Balancer，定位是高级负载均衡产品，在一些特定场景下用于替代 NSX 自带的 LB 。

# 功能特性

- 负载均衡
  - L7 HTTP/HTTPS 负载均衡
  - L4 TCP/UDP 负载均衡
  - 全局负载均衡（GSLB）
  - content switching
  - 缓存/压缩
- 安全
  - WAF
  - SSL 终止
  - DDoS保护
  - L3~L4 ACL
  - L7 规则
  - 微分段
- 分析
  - 应用地图
  - 服务健康评分
  - 网络性能
  - 应用性能
  - 请求日志
  - 安全可视化
- 其他
  - 集中管理
  - 100% API
  - 多租户
  - 服务发现
  - IPAM/DNS

# 架构

Avi 的架构非常简单，包含：

- **控制层**：Avi Controller，可以是 1 台或者 3 台虚拟机，负责提供 UI 和 API，所有负载均衡的配置均在 Controller 中进行配置，Controller 自动根据配置来创建/配置 Service Engine，另外 Controller 也可以通过 SE 来收集性能数据来做统一的展示和分析。
- **数据层**：Avi Service Engine，通过 Controller 自动部署或者手动导入，负责为应用提供负载均衡服务。

<img src="../../../pics/image-20200406180047213.png" alt="image-20200406180047213" style="zoom:40%;" />



# 资源需求

## 虚拟硬件

Avi 支持在 vSphere、Openstack、AWS 等多种云环境中安装，本文档只介绍 Avi 与 vSphere 集成。

默认 Avi Controller 需要 8vCPU、24G内存、128G 硬盘。

Avi Service Engine 默认规模是 1vCPU、2G内存、10G硬盘，最小可配置为 1vCPU、2G内存、10G硬盘，最大可设置为 64vCPU、256G内存。

如果为 SE 新增了一个 vCPU，应该对应地新增 1GB 内存

*注：Avi Controller 仅支持从 vCenter 导入，不支持通过 ESXi 导入。

## IP地址

Avi Controller 只需要一个 IP 地址，此地址用于连接所有 Avi Service Engine，也用于提供 UI 和 API，还用于和 vCenter 对接。所以要求此 IP 地址能够访问所有 Avi Service Engine 管理网络、vCenter、ESXi。建议使用静态 IP 地址分配。

*注：如果要组建 Controller 集群，三个节点必须在同一个网段中

Avi SE 至少需要三个 IP：

- 管理 IP：用于和 Avi Controller 通信，此地址可以通过 DHCP、地址池、手动分配的方式指定，一般使用地支持的方式。
- VIP：虚拟服务 IP，此地址在设置 Virtual service 时手动指定，或者通过 IPAM 服务自动分配。
- 连接后端服务器池的 IP：此地址的设定接下来的文章和之后的文章会细讲。



# 性能

## CPU

Avi Service Engine 使用 CPU 来进行 SSL 握手（TPS）、压缩、WAF、流量转发等任务，随着 CPU core 的增加 Avi Service Engine 的性能可以线性增加，建议将相关虚拟机的 CPU 设为预留以保障以上功能的性能。

另外 Service Engine 不能识别服务器是否开启了超线程，一般使用超线程的性能会弱于不使用超线程，因此如果有较高性能要求建议服务器关闭超线程。

## 内存

内存用来进行 HTTP 缓存及增加并发连接，增加内存大小可以有效增加这两个功能的处理能力。

默认 Service Engine 的内存为 2GB，默认开启内存预留。

## 磁盘

SE 会临时保存一些日志（之后这些日志会发给 Controller 进行索引），磁盘空间越大，SE 的日志保存时间可以设置的更久。如果使用 SSD，日志保存速度也会更快。

## PPS（packet per second）

Avi 在虚拟化中的性能受限于 Hypervisior，vSphere 5.5 每虚拟机的性能为 550k pps，vSphere 6.x 每虚拟机的性能为 1.2m pps。

baremetal 下性能则受限于使用的网卡。

Avi Service 也支持 DPDK，当使用 DPDK 时可以突破 Hypervisior 的 PPS 限制，目前有以下网卡支持 DPDK：82599, X520, X540, X550, X552, X710, XL710。

## RPS（request per second） 

RPS 取决于 CPU 型号和 PPS，一般每核的性能为  35~40k RPS。



# 部署 Avi Controller





# 参考文档

[https://avinetworks.com/docs/latest/installing-avi-vantage-for-vmware-vcenter/](https://avinetworks.com/docs/latest/installing-avi-vantage-for-vmware-vcenter/)

[https://avinetworks.com/docs/latest/system-requirements-hardware/](https://avinetworks.com/docs/latest/system-requirements-hardware/)

[https://avinetworks.com/docs/latest/sizing-service-engines/](https://avinetworks.com/docs/latest/sizing-service-engines/)